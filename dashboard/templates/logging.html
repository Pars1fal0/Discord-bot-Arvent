{% extends "base.html" %}

{% block title %}–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | {{ guild.name }}{% endblock %}

{% block content %}
<div class="server-layout">
    <!-- Sidebar -->
    <aside class="sidebar glass-card">
        <div class="sidebar-header">
            {% if guild.icon %}
            <img src="https://cdn.discordapp.com/icons/{{ guild.id }}/{{ guild.icon }}.png?size=64"
                alt="{{ guild.name }}" class="sidebar-icon">
            {% else %}
            <div class="sidebar-icon-placeholder">{{ guild.name[0] }}</div>
            {% endif %}
            <h2 class="sidebar-title">{{ guild.name }}</h2>
        </div>

        <nav class="sidebar-nav">
            <a href="{{ url_for('views.server_dashboard', guild_id=guild_id) }}" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">–û–±–∑–æ—Ä</span>
            </a>
            <a href="{{ url_for('views.moderation_page', guild_id=guild_id) }}" class="nav-item">
                <span class="nav-icon">üõ°Ô∏è</span>
                <span class="nav-text">–ú–æ–¥–µ—Ä–∞—Ü–∏—è</span>
            </a>
            <a href="{{ url_for('views.logging_page', guild_id=guild_id) }}" class="nav-item active">
                <span class="nav-icon">üìã</span>
                <span class="nav-text">–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
            </a>
            <a href="{{ url_for('views.tickets_page', guild_id=guild_id) }}" class="nav-item">
                <span class="nav-icon">üé´</span>
                <span class="nav-text">–¢–∏–∫–µ—Ç—ã</span>
            </a>
            <a href="{{ url_for('views.autorole_page', guild_id=guild_id) }}" class="nav-item">
                <span class="nav-icon">üëã</span>
                <span class="nav-text">–ê–≤—Ç–æ—Ä–æ–ª–µ–π</span>
            </a>
            <a href="{{ url_for('views.tempvoice_page', guild_id=guild_id) }}" class="nav-item">
                <span class="nav-icon">üé§</span>
                <span class="nav-text">–í–æ–π—Å-–∫–∞–Ω–∞–ª—ã</span>
            </a>
            <a href="{{ url_for('views.streams_page', guild_id=guild_id) }}" class="nav-item">
                <span class="nav-icon">üì∫</span>
                <span class="nav-text">–°—Ç—Ä–∏–º—ã</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="{{ url_for('views.dashboard') }}" class="nav-item nav-back">
                <span class="nav-icon">‚Üê</span>
                <span class="nav-text">–ù–∞–∑–∞–¥ –∫ —Å–µ—Ä–≤–µ—Ä–∞–º</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="server-content">
        <div class="page-header">
            <h1>üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è</h1>
            <p class="page-subtitle">–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</p>
        </div>

        <form id="logging-form" class="settings-form">
            <!-- Log Channel -->
            <div class="form-section glass-card">
                <h3 class="section-title">üìå –ö–∞–Ω–∞–ª –¥–ª—è –ª–æ–≥–æ–≤</h3>
                <p class="section-description">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª –∫—É–¥–∞ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –ª–æ–≥–∏ —Å–æ–±—ã—Ç–∏–π</p>

                <div class="form-group">
                    <label for="log-channel">–ö–∞–Ω–∞–ª</label>
                    <select id="log-channel" name="log_channel" class="form-select">
                        <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ)</option>
                    </select>
                </div>
            </div>

            <!-- Events -->
            <div class="form-section glass-card">
                <h3 class="section-title">üìä –°–æ–±—ã—Ç–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                <p class="section-description">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –¥–æ–ª–∂–Ω—ã –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è</p>

                <div class="checkbox-grid">
                    <label class="checkbox-card">
                        <input type="checkbox" id="event-message_delete" name="message_delete">
                        <span class="checkbox-content">
                            <span class="checkbox-icon">üóëÔ∏è</span>
                            <span class="checkbox-label">–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                        </span>
                    </label>

                    <label class="checkbox-card">
                        <input type="checkbox" id="event-message_edit" name="message_edit">
                        <span class="checkbox-content">
                            <span class="checkbox-icon">‚úèÔ∏è</span>
                            <span class="checkbox-label">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                        </span>
                    </label>

                    <label class="checkbox-card">
                        <input type="checkbox" id="event-member_join" name="member_join">
                        <span class="checkbox-content">
                            <span class="checkbox-icon">üì•</span>
                            <span class="checkbox-label">–í—Ö–æ–¥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                        </span>
                    </label>

                    <label class="checkbox-card">
                        <input type="checkbox" id="event-member_leave" name="member_leave">
                        <span class="checkbox-content">
                            <span class="checkbox-icon">üì§</span>
                            <span class="checkbox-label">–í—ã—Ö–æ–¥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                        </span>
                    </label>

                    <label class="checkbox-card">
                        <input type="checkbox" id="event-member_ban" name="member_ban">
                        <span class="checkbox-content">
                            <span class="checkbox-icon">üî®</span>
                            <span class="checkbox-label">–ë–∞–Ω—ã</span>
                        </span>
                    </label>

                    <label class="checkbox-card">
                        <input type="checkbox" id="event-member_unban" name="member_unban">
                        <span class="checkbox-content">
                            <span class="checkbox-icon">üîì</span>
                            <span class="checkbox-label">–†–∞–∑–±–∞–Ω—ã</span>
                        </span>
                    </label>

                    <label class="checkbox-card">
                        <input type="checkbox" id="event-member_update" name="member_update">
                        <span class="checkbox-content">
                            <span class="checkbox-icon">üë§</span>
                            <span class="checkbox-label">–ò–∑–º–µ–Ω–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                        </span>
                    </label>

                    <label class="checkbox-card">
                        <input type="checkbox" id="event-role_changes" name="role_changes">
                        <span class="checkbox-content">
                            <span class="checkbox-icon">üé≠</span>
                            <span class="checkbox-label">–ò–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–µ–π</span>
                        </span>
                    </label>

                    <label class="checkbox-card">
                        <input type="checkbox" id="event-channel_changes" name="channel_changes">
                        <span class="checkbox-content">
                            <span class="checkbox-icon">üìÅ</span>
                            <span class="checkbox-label">–ò–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤</span>
                        </span>
                    </label>

                    <label class="checkbox-card">
                        <input type="checkbox" id="event-voice_changes" name="voice_changes">
                        <span class="checkbox-content">
                            <span class="checkbox-icon">üîä</span>
                            <span class="checkbox-label">–ì–æ–ª–æ—Å–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã</span>
                        </span>
                    </label>
                </div>

                <div class="form-group" style="margin-top: 1rem;">
                    <button type="button" class="btn btn-ghost" onclick="toggleAllEvents(true)">
                        –í–∫–ª—é—á–∏—Ç—å –≤—Å–µ
                    </button>
                    <button type="button" class="btn btn-ghost" onclick="toggleAllEvents(false)">
                        –í—ã–∫–ª—é—á–∏—Ç—å –≤—Å–µ
                    </button>
                </div>
            </div>

            <!-- Save Button -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    const guildId = '{{ guild_id }}';

    const eventTypes = [
        'message_delete', 'message_edit', 'member_join', 'member_leave',
        'member_ban', 'member_unban', 'member_update', 'role_changes',
        'channel_changes', 'voice_changes'
    ];

    // Load data on page load
    document.addEventListener('DOMContentLoaded', async () => {
        await loadChannels();
        await loadSettings();
    });

    async function loadChannels() {
        try {
            const response = await fetch(`/api/guild/${guildId}/channels`);
            const channels = await response.json();

            const select = document.getElementById('log-channel');
            channels.text.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel.id;
                option.textContent = `#${channel.name}`;
                if (channel.category_name) {
                    option.textContent += ` (${channel.category_name})`;
                }
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading channels:', error);
        }
    }

    async function loadSettings() {
        try {
            const response = await fetch(`/api/guild/${guildId}/logging`);
            const settings = await response.json();

            // Set log channel
            if (settings.log_channel) {
                document.getElementById('log-channel').value = settings.log_channel;
            }

            // Set enabled events
            const enabledEvents = settings.enabled_events || {};
            eventTypes.forEach(event => {
                const checkbox = document.getElementById(`event-${event}`);
                if (checkbox) {
                    checkbox.checked = enabledEvents[event] !== false;
                }
            });
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    }

    function toggleAllEvents(enable) {
        eventTypes.forEach(event => {
            const checkbox = document.getElementById(`event-${event}`);
            if (checkbox) {
                checkbox.checked = enable;
            }
        });
    }

    // Form submit
    document.getElementById('logging-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const enabledEvents = {};
        eventTypes.forEach(event => {
            const checkbox = document.getElementById(`event-${event}`);
            enabledEvents[event] = checkbox ? checkbox.checked : false;
        });

        const data = {
            log_channel: document.getElementById('log-channel').value || null,
            enabled_events: enabledEvents
        };

        try {
            const response = await fetch(`/api/guild/${guildId}/logging`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
            } else {
                showToast(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
            }
        } catch (error) {
            console.error('Error saving settings:', error);
            showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
        }
    });
</script>
{% endblock %}