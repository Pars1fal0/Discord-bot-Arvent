{% extends "base.html" %}

{% block title %}–¢–∏–∫–µ—Ç—ã | {{ guild.name }}{% endblock %}

{% block content %}
<div class="server-layout">
    <!-- Sidebar -->
    <aside class="sidebar glass-card">
        <div class="sidebar-header">
            {% if guild.icon %}
            <img src="https://cdn.discordapp.com/icons/{{ guild.id }}/{{ guild.icon }}.png?size=64"
                alt="{{ guild.name }}" class="sidebar-icon">
            {% else %}
            <div class="sidebar-icon-placeholder">{{ guild.name[0] }}</div>
            {% endif %}
            <h2 class="sidebar-title">{{ guild.name }}</h2>
        </div>

        <nav class="sidebar-nav">
            <a href="{{ url_for('views.server_dashboard', guild_id=guild_id) }}" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">–û–±–∑–æ—Ä</span>
            </a>
            <a href="{{ url_for('views.moderation_page', guild_id=guild_id) }}" class="nav-item">
                <span class="nav-icon">üõ°Ô∏è</span>
                <span class="nav-text">–ú–æ–¥–µ—Ä–∞—Ü–∏—è</span>
            </a>
            <a href="{{ url_for('views.logging_page', guild_id=guild_id) }}" class="nav-item">
                <span class="nav-icon">üìã</span>
                <span class="nav-text">–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
            </a>
            <a href="{{ url_for('views.tickets_page', guild_id=guild_id) }}" class="nav-item active">
                <span class="nav-icon">üé´</span>
                <span class="nav-text">–¢–∏–∫–µ—Ç—ã</span>
            </a>
            <a href="{{ url_for('views.autorole_page', guild_id=guild_id) }}" class="nav-item">
                <span class="nav-icon">üëã</span>
                <span class="nav-text">–ê–≤—Ç–æ—Ä–æ–ª–µ–π</span>
            </a>
            <a href="{{ url_for('views.tempvoice_page', guild_id=guild_id) }}" class="nav-item">
                <span class="nav-icon">üé§</span>
                <span class="nav-text">–í–æ–π—Å-–∫–∞–Ω–∞–ª—ã</span>
            </a>
            <a href="{{ url_for('views.streams_page', guild_id=guild_id) }}" class="nav-item">
                <span class="nav-icon">üì∫</span>
                <span class="nav-text">–°—Ç—Ä–∏–º—ã</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="{{ url_for('views.dashboard') }}" class="nav-item nav-back">
                <span class="nav-icon">‚Üê</span>
                <span class="nav-text">–ù–∞–∑–∞–¥ –∫ —Å–µ—Ä–≤–µ—Ä–∞–º</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="server-content">
        <div class="page-header">
            <h1>üé´ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤</h1>
            <p class="page-subtitle">–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
        </div>

        <form id="tickets-form" class="settings-form">
            <!-- Bug Reports -->
            <div class="form-section glass-card">
                <h3 class="section-title">üêõ –ë–∞–≥–∏</h3>
                <p class="section-description">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ç–∏–∫–µ—Ç–æ–≤ —Å –±–∞–≥–∞–º–∏</p>

                <div class="form-row">
                    <div class="form-group">
                        <label for="bug-role">–†–æ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</label>
                        <select id="bug-role" name="bug_role" class="form-select role-select">
                            <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bug-category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select id="bug-category" name="bug_category" class="form-select category-select">
                            <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Ideas -->
            <div class="form-section glass-card">
                <h3 class="section-title">üí° –ò–¥–µ–∏</h3>
                <p class="section-description">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ç–∏–∫–µ—Ç–æ–≤ —Å –∏–¥–µ—è–º–∏</p>

                <div class="form-row">
                    <div class="form-group">
                        <label for="idea-role">–†–æ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</label>
                        <select id="idea-role" name="idea_role" class="form-select role-select">
                            <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="idea-category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select id="idea-category" name="idea_category" class="form-select category-select">
                            <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Complaints -->
            <div class="form-section glass-card">
                <h3 class="section-title">‚ö†Ô∏è –ñ–∞–ª–æ–±—ã</h3>
                <p class="section-description">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∂–∞–ª–æ–±</p>

                <div class="form-row">
                    <div class="form-group">
                        <label for="complaint-role">–†–æ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</label>
                        <select id="complaint-role" name="complaint_role" class="form-select role-select">
                            <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="complaint-category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select id="complaint-category" name="complaint_category" class="form-select category-select">
                            <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    const guildId = '{{ guild_id }}';

    document.addEventListener('DOMContentLoaded', async () => {
        await Promise.all([loadRoles(), loadChannels()]);
        await loadSettings();
    });

    async function loadRoles() {
        try {
            const response = await fetch(`/api/guild/${guildId}/roles`);
            const roles = await response.json();

            document.querySelectorAll('.role-select').forEach(select => {
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = `@${role.name}`;
                    option.style.color = role.color;
                    select.appendChild(option);
                });
            });
        } catch (error) {
            console.error('Error loading roles:', error);
        }
    }

    async function loadChannels() {
        try {
            const response = await fetch(`/api/guild/${guildId}/channels`);
            const channels = await response.json();

            document.querySelectorAll('.category-select').forEach(select => {
                channels.category.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = `üìÅ ${category.name}`;
                    select.appendChild(option);
                });
            });
        } catch (error) {
            console.error('Error loading channels:', error);
        }
    }

    async function loadSettings() {
        try {
            const response = await fetch(`/api/guild/${guildId}/tickets`);
            const settings = await response.json();

            // Bug settings
            if (settings.bug) {
                if (settings.bug.support_role_id) {
                    document.getElementById('bug-role').value = settings.bug.support_role_id;
                }
                if (settings.bug.category_id) {
                    document.getElementById('bug-category').value = settings.bug.category_id;
                }
            }

            // Idea settings
            if (settings.idea) {
                if (settings.idea.support_role_id) {
                    document.getElementById('idea-role').value = settings.idea.support_role_id;
                }
                if (settings.idea.category_id) {
                    document.getElementById('idea-category').value = settings.idea.category_id;
                }
            }

            // Complaint settings
            if (settings.complaint) {
                if (settings.complaint.support_role_id) {
                    document.getElementById('complaint-role').value = settings.complaint.support_role_id;
                }
                if (settings.complaint.category_id) {
                    document.getElementById('complaint-category').value = settings.complaint.category_id;
                }
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    }

    // Form submit
    document.getElementById('tickets-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
            bug: {
                support_role_id: document.getElementById('bug-role').value || null,
                category_id: document.getElementById('bug-category').value || null
            },
            idea: {
                support_role_id: document.getElementById('idea-role').value || null,
                category_id: document.getElementById('idea-category').value || null
            },
            complaint: {
                support_role_id: document.getElementById('complaint-role').value || null,
                category_id: document.getElementById('complaint-category').value || null
            }
        };

        try {
            const response = await fetch(`/api/guild/${guildId}/tickets`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
            } else {
                showToast(result.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
            }
        } catch (error) {
            console.error('Error saving settings:', error);
            showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
        }
    });
</script>
{% endblock %}